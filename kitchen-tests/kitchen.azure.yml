---
driver:
  name: azurerm

driver_config:
  subscription_id: 80b824de-ec53-4116-9868-3deeab10b0cd
  location: West US2
  machine_size: Standard_B4ms

provisioner:
  name: chef_zero
  deprecations_as_errors: true
  chef_license: accept-no-persist
  product_name: chef
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true

lifecycle:
  pre_converge:
    - remote: echo "Chef container's Chef / Ohai release:"
    - remote: C:\opscode\chef\bin\chef-client -v
    - remote: C:\opscode\chef\bin\ohai -v
    - remote: C:\opscode\chef\embedded\bin\rake --version
    - remote: C:\opscode\chef\embedded\bin\bundle -v
    - remote: C:\opscode\chef\embedded\bin\gem install appbundler appbundle-updater --no-doc
    - remote: C:\opscode\chef\embedded\bin\appbundle-updater chef ohai <%= File.readlines('..\Gemfile.lock', File.expand_path(File.dirname(__FILE__))).find { |l| l =~ /^\s+ohai \((\d+\.\d+\.\d+)\)/ }; 'v' + $1 %> --tarball --github chef/ohai
    - remote: C:\opscode\chef\embedded\bin\appbundle-updater chef chef <%= ENV['BUILDKITE_COMMIT']  || %x(git rev-parse HEAD).chomp %> --tarball --github chef\chef
    - remote: echo "Installed Chef \ Ohai release:"
    - remote: C:\opscode\chef\bin\chef-client -v
    - remote: C:\opscode\chef\bin\ohai -v

transport:
  name: winrm

verifier:
  name: inspec
  format: progress

platforms:
- name: windows-10
  driver:
    image_id: /subscriptions/80b824de-ec53-4116-9868-3deeab10b0cd/resourceGroups/EDM_Master_Storage_Resource_Group/providers/Microsoft.Compute/images/chef16-win-10
    use_managed_disk: true
    winrm_powershell_script: |-
      Set-WSManQuickConfig -Force -SkipNetworkProfileCheck
      netsh advfirewall firewall set rule name="Windows Remote Management (HTTP-In)" profile=public protocol=tcp localport=5985 remoteip=localsubnet new remoteip=any
      Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::windows]
